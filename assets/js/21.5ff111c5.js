(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{216:function(e,a,t){"use strict";t.r(a);var r=t(2),s=Object(r.a)({},function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"queue"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#queue","aria-hidden":"true"}},[e._v("#")]),e._v(" queue")]),e._v(" "),t("p",[e._v("基于beanstalkd实现的任务队列，方便去分发任务和解决任务,此库可适用以下场景：")]),e._v(" "),t("ul",[t("li",[e._v("用作延时队列：比如可以用于如果用户30分钟内不操作，任务关闭。")]),e._v(" "),t("li",[e._v("用作定时任务：比如可以用于专门的后台任务。")]),e._v(" "),t("li",[e._v("用作异步操作：这是所有消息队列都最常用的，先将任务仍进去，顺序执行。")]),e._v(" "),t("li",[e._v("用作循环队列：用release命令可以循环执行任务，比如可以做负载均衡任务分发。")]),e._v(" "),t("li",[e._v("用作兜底机制：比如一个请求有失败的概率，可以用Beanstalk不断重试，设定超时时间，时间内尝试到成功为止")])]),e._v(" "),t("h2",{attrs:{id:"关于beanstalkd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#关于beanstalkd","aria-hidden":"true"}},[e._v("#")]),e._v(" 关于Beanstalkd")]),e._v(" "),t("p",[e._v("Beanstalkd 是一个轻量级的内存型队列，利用了和 Memcache 类似的协议。依赖 libevent 单线程事件分发机制, 可以部署多个实例，但是高并发支持还是不太友好；")]),e._v(" "),t("h2",{attrs:{id:"几个重要的概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#几个重要的概念","aria-hidden":"true"}},[e._v("#")]),e._v(" 几个重要的概念")]),e._v(" "),t("ul",[t("li",[e._v("job：一个需要异步处理的任务，是 Beanstalkd 中的基本单元，需要放在一个 tube 中。")]),e._v(" "),t("li",[e._v("tube：一个有名的任务队列，用来存储统一类型的 job，是 producer 和 consumer 操作的对象。")]),e._v(" "),t("li",[e._v("producer：Job 的生产者，通过 put 命令来将一个 job 放到一个 tube 中。")]),e._v(" "),t("li",[e._v("consumer：Job的消费者，通过 reserve/release/bury/delete 命令来获取 job 或改变 job 的状态。")])]),e._v(" "),t("h3",{attrs:{id:"job的生命周期"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#job的生命周期","aria-hidden":"true"}},[e._v("#")]),e._v(" Job的生命周期")]),e._v(" "),t("p",[e._v("任务在队里之中被称作 Job. 一个 Job 在 Beanstalkd 中有以下的生命周期：")]),e._v(" "),t("ul",[t("li",[e._v("put 将一个任务放置进 tube 中")]),e._v(" "),t("li",[e._v("deayed 这个任务现在再等待中，需要若干秒才能准备完毕【延迟队列】")]),e._v(" "),t("li",[e._v("ready 这个任务已经准备好了，可以消费了。所有的消费都是要从取 ready 状态的 job")]),e._v(" "),t("li",[e._v("reserved 这个任务已经被消费者消费")]),e._v(" "),t("li",[e._v("release 这个 job 执行失败了，把它放进 ready 状态队列中。让其他队列执行")]),e._v(" "),t("li",[e._v("bury 这个 job 执行失败了，但不希望其他队列执行，先把它埋起来")])]),e._v(" "),t("div",{staticClass:"language-php extra-class"},[t("pre",{pre:!0,attrs:{class:"language-php"}},[t("code",[e._v("    \n     put with delay               release with delay\n      "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),t("span",{pre:!0,attrs:{class:"token constant"}},[e._v("DELAYED")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("\n                            "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("                   "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n                            "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("time passes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("     "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n                            "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("                   "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n       put                  v     reserve       "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("       delete\n      "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),t("span",{pre:!0,attrs:{class:"token constant"}},[e._v("READY")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),t("span",{pre:!0,attrs:{class:"token constant"}},[e._v("RESERVED")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("poof"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("\n                           "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("^")]),e._v("  "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("^")]),e._v("                "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("  "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n                           "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("   \\  release      "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("  "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n                           "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("    `"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),t("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[e._v("'   |\n                           |                      |\n                           | kick                 |\n                           |                      |\n                           |       bury           |\n                        [BURIED] <---------------'")]),e._v("\n                           "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n                           "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("  delete\n                            `"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("poof"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("\n")])])]),t("h2",{attrs:{id:"怎么使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#怎么使用","aria-hidden":"true"}},[e._v("#")]),e._v(" 怎么使用")]),e._v(" "),t("p",[e._v("具体实例可参考"),t("a",{attrs:{href:"https://github.com/KickPeach/queue/blob/master/tests/QueueTest.php",target:"_blank",rel:"noopener noreferrer"}},[e._v("测试例子"),t("OutboundLink")],1)]),e._v(" "),t("h3",{attrs:{id:"安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装","aria-hidden":"true"}},[e._v("#")]),e._v(" 安装")]),e._v(" "),t("p",[t("code",[e._v("composer require kickpeach/queue -vvv")])]),e._v(" "),t("h3",{attrs:{id:"overview"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#overview","aria-hidden":"true"}},[e._v("#")]),e._v(" Overview")]),e._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#create-queue"}},[e._v("Create Queue")])]),e._v(" "),t("li",[t("a",{attrs:{href:"#create-job"}},[e._v("Create Job")])]),e._v(" "),t("li",[t("a",{attrs:{href:"#dispatch-job"}},[e._v("Dispatch Job")])]),e._v(" "),t("li",[t("a",{attrs:{href:"#process-job"}},[e._v("Process Job")])]),e._v(" "),t("li",[t("a",{attrs:{href:"#recommend"}},[e._v("Recommend")])]),e._v(" "),t("li",[t("a",{attrs:{href:"#example"}},[e._v("Example")])]),e._v(" "),t("li",[t("a",{attrs:{href:"#todo"}},[e._v("Todo")])])]),e._v(" "),t("h3",{attrs:{id:"create-queue"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#create-queue","aria-hidden":"true"}},[e._v("#")]),e._v(" Create Queue")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("use KickPeach\\Queue\\Drivers\\Beanstalkd;\nuse KickPeach\\Queue\\Queue;\n\n$queue = new Queue(new Beanstalkd($host, $port));\n")])])]),t("h3",{attrs:{id:"create-job"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#create-job","aria-hidden":"true"}},[e._v("#")]),e._v(" Create Job")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("<?php\n\nuse KickPeach\\Queue\\Job;\n\nclass ExampleJob extends Job\n{\n    /**\n     * @var string job queue name (beanstalkd tube)\n     */\n    public $queue = 'default';\n\n    /**\n     * The \"time to run\" for all pushed jobs. (beanstalkd ttr, timeout)\n     *\n     * @var int 允许 worker 执行的最大秒数,超时 job 将会被 release 到 ready 状态.\n     */\n    public $retry_after = 60;\n\n    /**\n     * The number of times the job may be attempted.\n     *\n     * @var int 最大尝试次数\n     */\n    public $tries = 1;\n\n    /**\n     * @var array\n     */\n    public $words;\n\n    public function __construct(array $words)\n    {\n        $this->words = $words;\n    }\n\n    public function handle()\n    {\n        var_export($this->words);\n\n        var_dump($this->retry_after, $this->tries);\n\n        // throw new \\Exception('handle job with error...lol ^_^');\n    }\n}\n")])])]),t("p",[e._v("specifying job queue by defining "),t("code",[e._v("$queue")]),e._v(" , specifying Max Job Attempts by defining "),t("code",[e._v("$tries")]),e._v(" , specifying timeout Values by defining "),t("code",[e._v("$retry_after")]),e._v(" .")]),e._v(" "),t("h3",{attrs:{id:"dispatch-job"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dispatch-job","aria-hidden":"true"}},[e._v("#")]),e._v(" Dispatch Job")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("$queue->push(new ExampleJob(['i', 'love', 'china']));\n")])])]),t("p",[e._v("of cause, you can dispatch job later (push a delayed job) :")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("$queue->later(60, new ExampleJob(['i', 'love', 'china']));\n")])])]),t("h3",{attrs:{id:"process-job"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#process-job","aria-hidden":"true"}},[e._v("#")]),e._v(" Process Job")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("$worker = new Worker($queue);\n\n$worker->daemon();\n")])])]),t("blockquote",[t("p",[e._v("Note: "),t("code",[e._v("$worker->daemon()")]),e._v(" is blocking.")])]),e._v(" "),t("p",[e._v("by default, the worker will will listen  the tube named "),t("code",[e._v("default")]),e._v(", you can specifying worker queue (beanstalkd tube) like :")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("$queueTube = 'sendEmail';\n$worker = new Worker($queue, $queueTube);\n\n$worker->daemon();\n")])])]),t("p",[e._v("you can specifying worker with sleep time while there is no job, and memoryLimit, like :")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("$sleep = 60;\n$memoryLimit = 128;\n\n$queueTube = 'sendEmail';\n$worker = new Worker($queue, $queueTube);\n\n$worker->daemon($sleep, $memoryLimit);\n")])])]),t("h1",{attrs:{id:"license"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#license","aria-hidden":"true"}},[e._v("#")]),e._v(" License")]),e._v(" "),t("p",[e._v("The MIT License (MIT).")])])},[],!1,null,null,null);a.default=s.exports}}]);